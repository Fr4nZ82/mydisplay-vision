<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyDisplay Vision – Report</title>
    <style>
      :root{
        color-scheme:dark;
        --bg:#0f1115; --card:#131722; --muted:#94a3b8; --text:#e5e7eb; --border:#202634; --accent:#7dd3fc;
      }
      *{ box-sizing:border-box }
      html, body{ height:100% }
      body{
        margin:0; background:var(--bg); color:var(--text);
        font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;
      }
      .wrap{ max-width:1400px; margin:0 auto; padding:18px }
      header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px }
      .title{ font-size:18px; font-weight:700; letter-spacing:.2px }
      .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
      .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
      .kpis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; margin-bottom:14px }
      .kpi{ display:flex; flex-direction:column; gap:6px }
      .kpi .lbl{ color:var(--muted); font-size:12px }
      .kpi .val{ font-size:20px; font-weight:700 }
      .grid{ display:grid; grid-template-columns:1.5fr 1fr; gap:12px }
      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px }
      .sub{ color:var(--muted); font-size:12px }
      .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
      button,select{ background:#0b0e16; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
      button:hover{ border-color:#2c3549 }
      table{ width:100%; border-collapse:collapse }
      th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:left }
      th{ color:var(--muted); font-weight:600; font-size:12px }
      tbody tr:hover{ background:#0e1420 }
      .foot{ margin-top:18px; color:var(--muted); font-size:12px }

      /* Chart areas sized by container */
      .chart-box{ position:relative; height:320px; }
      .chart-sm{ height:180px; }
      .chart-square{ width:100%; aspect-ratio:1 / 1; max-height:150px; display:flex; align-items:center; justify-content:center; }
      .chart-square canvas{ aspect-ratio:1 / 1 !important; height:auto !important; width:auto !important; max-width:150px; }
      canvas{ display:block; width:100% !important; height:100% !important; }

      @media (max-width: 1100px){ .grid{ grid-template-columns:1fr } }
      @media (max-width: 900px){ .kpis{ grid-template-columns:repeat(2,1fr) } }
    </style>
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <div class="title">MyDisplay Vision – Report metriche</div>
          <div class="sub">Conteggio persone · sesso · età · finestra temporale</div>
        </div>
        <div class="controls">
          <div class="toolbar">
            <label for="range">Intervallo</label>
            <select id="range">
              <option value="today">Oggi</option>
              <option value="yesterday">Ieri</option>
              <option value="7d" selected>Ultimi 7 giorni</option>
              <option value="30d">Ultimi 30 giorni</option>
            </select>
            <button id="regen">Aggiorna dati</button>
            <button id="csv">Esporta CSV</button>
            <button id="pdf">Esporta PDF</button>
          </div>
        </div>
      </header>

      <section class="card kpis" id="kpiBox">
        <div class="kpi">
          <div class="lbl">Visitatori (stimati)</div>
          <div class="val" id="kpiVisitors">–</div>
          <div class="sub" id="kpiVisitorsSub">Somma persone uniche stimate</div>
        </div>
        <div class="kpi">
          <div class="lbl">Pico orario</div>
          <div class="val" id="kpiPeak">–</div>
          <div class="sub" id="kpiPeakSub">Ora con passaggi massimi</div>
        </div>
        <div class="kpi">
          <div class="lbl">Genere</div>
          <div class="val" id="kpiGender">–</div>
          <div class="sub" id="kpiGenderSub">F / M / U</div>
        </div>
        <div class="kpi">
          <div class="lbl">Età mediana</div>
          <div class="val" id="kpiAge">–</div>
          <div class="sub" id="kpiAgeSub">Distribuzione a fasce</div>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <div class="sub" style="margin-bottom:8px">Distribuzione traffico (radiale)</div>
          <div class="chart-box">
            <canvas id="chartTime"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="sub" style="margin-bottom:8px">Serie per genere (giorni)</div>
          <div class="chart-box">
            <canvas id="chartGenderDaily"></canvas>
          </div>
        </div>
      </section>

      <section class="grid2">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div class="sub">Riepilogo per giorno/ora</div>
          </div>
          <table id="tblDaily">
            <thead>
              <tr>
                <th>Data</th><th>Totale</th><th>F</th><th>M</th><th>U</th><th>Età mediana</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <div class="sub" style="margin-bottom:6px">Top ore per traffico</div>
          <table id="tblTop">
            <thead>
              <tr>
                <th>Giorno</th><th>Ora</th><th>Passaggi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <div class="foot">
        ⚠️ Demo ⚠️
      </div>
    </div>

    <script>
      // ====== Utility ======
      const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
      const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
      function formatDate(d){return d.toISOString().slice(0,10)}
      function pad2(n){return (n<10?'0':'')+n}

      // ====== Fake data generator ======
      function generateTimeline(range){
        const now = new Date();
        let start, stepMs, points;
        if(range==='today'){
          start = new Date(now); start.setHours(0,0,0,0); stepMs = 60*60*1000; points=24; // hourly
        } else if(range==='yesterday'){
          start = new Date(now); start.setDate(now.getDate()-1); start.setHours(0,0,0,0); stepMs=60*60*1000; points=24;
        } else if(range==='30d'){
          start = new Date(now); start.setDate(now.getDate()-29); start.setHours(0,0,0,0); stepMs=24*60*60*1000; points=30; // daily
        } else { // 7d
          start = new Date(now); start.setDate(now.getDate()-6); start.setHours(0,0,0,0); stepMs=24*60*60*1000; points=7; // daily
        }
        const labels=[], values=[];
        let base = range==='today'||range==='yesterday'?rnd(4,18):rnd(50,180);
        for(let i=0;i<points;i++){
          const t = new Date(start.getTime()+i*stepMs);
          labels.push(range==='today'||range==='yesterday'? `${pad2(t.getHours())}:00` : formatDate(t));
          // daily/diurnal pattern bumps
          let bump = 0;
          if(stepMs<24*60*60*1000){ // hourly
            const h=t.getHours();
            if(h>=7&&h<=9) bump+=rnd(8,18); // morning rush
            if(h>=12&&h<=13) bump+=rnd(6,14); // lunch
            if(h>=17&&h<=19) bump+=rnd(9,22); // evening peak
          } else {
            const dow = t.getDay(); // weekend effect
            if(dow===6||dow===0) bump+=rnd(15,40);
          }
          base = clamp(base + rnd(-5,6), 2, 300);
          values.push(clamp(Math.round(base + bump + rnd(-3,3)), 0, 9999));
        }
        return {labels, values};
      }

      function deriveGenderTotals(total){
        let f = Math.round(total * (0.35 + Math.random()*0.25));
        let m = Math.round(total * (0.35 + Math.random()*0.25));
        let u = clamp(total - f - m, 0, total);
        return {f,m,u};
      }

      function deriveAgeBuckets(total){
        const buckets = ["0-12","13-17","18-24","25-34","35-44","45-54","55-64","65+"];
        const weights = [0.04,0.06,0.12,0.22,0.20,0.17,0.11,0.08].map(w=>w*(0.9+Math.random()*0.2));
        const sumW = weights.reduce((a,b)=>a+b,0);
        const counts = weights.map(w=>Math.round(total * w / sumW));
        const diff = total - counts.reduce((a,b)=>a+b,0);
        counts[counts.length-1]+=diff;
        return {buckets, counts};
      }

      function summarizeDaily(range, ts){
        const rows=[];
        if(ts.labels.length===24){
          const today = new Date();
          const date = range==='yesterday'? new Date(today.getFullYear(),today.getMonth(),today.getDate()-1) : today;
          const total = ts.values.reduce((a,b)=>a+b,0);
          const g = deriveGenderTotals(total);
          const age = deriveAgeBuckets(total);
          rows.push({date:formatDate(date), total, ...g, median: estimateMedianAge(age)});
        } else {
          for(let i=0;i<ts.labels.length;i++){
            const total = ts.values[i];
            const g = deriveGenderTotals(total);
            const age = deriveAgeBuckets(total);
            rows.push({date:ts.labels[i], total, ...g, median: estimateMedianAge(age)});
          }
        }
        return rows;
      }

      function estimateMedianAge(age){
        const mids = [6,15,21,29,39,49,59,72];
        const {counts} = age;
        const total = counts.reduce((a,b)=>a+b,0);
        let acc=0;
        for(let i=0;i<counts.length;i++){
          acc += counts[i];
          if(acc>=total/2) return mids[i];
        }
        return 0;
      }

      function topHoursFrom(ts){
        const entries=[];
        if(ts.labels.length===24){
          ts.labels.forEach((h,i)=>entries.push({day:"oggi", hour:h, val:ts.values[i]}));
        } else {
          for(let d=0; d<ts.labels.length; d++){
            const base = Math.max(4, Math.round(ts.values[d]/24));
            const peaks = [rnd(8,10), rnd(12,14), rnd(17,19)];
            for(const p of peaks){ entries.push({day:ts.labels[d], hour: pad2(p)+":00", val: clamp(base + rnd(12,40), 0, 999)}); }
          }
        }
        entries.sort((a,b)=>b.val-a.val);
        return entries.slice(0,8);
      }

      // ====== Helper: build distribution for radial chart ======
      function buildDistribution(ts){
        if(ts.labels.length===24){
          // Raggruppa per fasce orarie
          const bands = [
            {lbl:'Notte (00–06)', idx:[0,1,2,3,4,5,6]},
            {lbl:'Mattina (07–11)', idx:[7,8,9,10,11]},
            {lbl:'Pranzo (12–16)', idx:[12,13,14,15,16]},
            {lbl:'Sera (17–23)', idx:[17,18,19,20,21,22,23]},
          ];
          const labels = bands.map(b=>b.lbl);
          const values = bands.map(b=>b.idx.reduce((sum,h)=>sum+(ts.values[h]||0),0));
          return {labels, values};
        } else {
          // Distribuzione per giorno
          return {labels: ts.labels.slice(), values: ts.values.slice()};
        }
      }

      // ====== Charts ======
      let chartTime, chartGenderDaily;
      function renderCharts(ts, dailyRows){
        const ctxT = document.getElementById('chartTime');
        const ctxGD = document.getElementById('chartGenderDaily');

        // --- NEW: Polar Area (distribution) replacing area-time chart ---
        const dist = buildDistribution(ts);
        const colors = dist.labels.map((_,i)=>{
          const base = [125,211,252]; // accent base
          const a = 0.25 + (i % 5) * 0.12;
          return `rgba(${base[0]},${base[1]},${base[2]},${a})`;
        });
        const timeCfg = {
          type:'polarArea',
          data:{ labels: dist.labels, datasets:[{
            label:'Distribuzione traffico',
            data: dist.values,
            backgroundColor: colors,
            borderColor:'#1e2636',
            borderWidth:1
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ position:'right', labels:{ usePointStyle:true } } },
            scales:{ r:{ grid:{ color:'#1e2636' }, angleLines:{ color:'#1e2636' }, ticks:{ display:false } } }
          }
        };

        // Build stacked gender-by-day dataset from dailyRows
        const labels = dailyRows.map(r=>r.date);
        const dataF = dailyRows.map(r=>r.f);
        const dataM = dailyRows.map(r=>r.m);
        const dataU = dailyRows.map(r=>r.u);

        // Spaziatura dinamica per far entrare fino a 30 colonne
        const n = labels.length || 1;
        const categoryPct = Math.max(0.22, Math.min(0.9, 7 / n)); // più colonne -> categorie più strette
        const barPct = Math.max(0.35, Math.min(0.9, 6 / n));
        const maxBarThickness = Math.max(6, Math.min(14, Math.round(120 / n)));

        const genderDailyCfg = {
          type:'bar',
          data:{ labels, datasets:[
            {label:'Femminile', data:dataF, backgroundColor:'#f472b6', borderColor:'#be185d', borderWidth:0.5, stack:'gender',
             categoryPercentage:categoryPct, barPercentage:barPct, maxBarThickness},
            {label:'Maschile', data:dataM, backgroundColor:'#60a5fa', borderColor:'#1d4ed8', borderWidth:0.5, stack:'gender',
             categoryPercentage:categoryPct, barPercentage:barPct, maxBarThickness},
            {label:'Sconosciuto', data:dataU, backgroundColor:'#94a3b8', borderColor:'#475569', borderWidth:0.5, stack:'gender',
             categoryPercentage:categoryPct, barPercentage:barPct, maxBarThickness}
          ]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ position:'top', labels:{ usePointStyle:true } } },
            scales:{
              x:{ stacked:true, grid:{color:'#1e2636'} },
              y:{ stacked:true, beginAtZero:true, grid:{color:'#1e2636'} }
            }
          }
        };

        if(chartTime) chartTime.destroy();
        if(chartGenderDaily) chartGenderDaily.destroy();
        chartTime = new Chart(ctxT, timeCfg);
        chartGenderDaily = new Chart(ctxGD, genderDailyCfg);
      }

      // ====== Tables ======
      function fillTableDaily(rows){
        const tb = document.querySelector('#tblDaily tbody');
        tb.innerHTML = rows.map(r=>`<tr><td>${r.date}</td><td>${r.total}</td><td>${r.f}</td><td>${r.m}</td><td>${r.u}</td><td>${r.median}</td></tr>`).join('');
      }
      function fillTableTop(rows){
        const tb = document.querySelector('#tblTop tbody');
        tb.innerHTML = rows.map(r=>`<tr><td>${r.day}</td><td>${r.hour}</td><td>${r.val}</td></tr>`).join('');
      }

      // ====== KPIs ======
      function updateKpis(ts, g, age){
        const total = ts.values.reduce((a,b)=>a+b,0);
        const peak = Math.max(...ts.values);
        const peakIdx = ts.values.indexOf(peak);
        const peakLabel = ts.labels[peakIdx];
        const median = estimateMedianAge(age);
        document.getElementById('kpiVisitors').textContent = total.toLocaleString('it-IT');
        document.getElementById('kpiPeak').textContent = peak.toLocaleString('it-IT');
        document.getElementById('kpiPeakSub').textContent = `Picco: ${peakLabel}`;
        document.getElementById('kpiGender').textContent = `${g.f}/${g.m}/${g.u}`;
        document.getElementById('kpiAge').textContent = `${median}`;
      }

      // ====== CSV Export ======
      function exportCSV(ts, dailyRows, age, gender){
        const lines = [];
        const rangeVal = (document.getElementById('range')||{}).value || '7d';
        const rangeLbl = ({today:'Oggi',yesterday:'Ieri','7d':'Ultimi 7 giorni','30d':'Ultimi 30 giorni'})[rangeVal] || rangeVal;
        const gran = ts.labels.length===24 ? 'Oraria' : 'Giornaliera';
        const genAt = new Date();
        const totalVisitors = ts.values.reduce((a,b)=>a+b,0);
        const percent = (part,total)=> total>0 ? ((part/total)*100).toFixed(1)+'%' : '0%';

        // Meta
        lines.push('Sezione,Campo,Valore');
        lines.push(`Meta,Generato il,${genAt.toLocaleString('it-IT')}`);
        lines.push(`Meta,Intervallo selezionato,${rangeLbl}`);
        lines.push(`Meta,Granularità serie temporale,${gran}`);
        lines.push(`Meta,Visitatori totali (stima),${totalVisitors}`);
        lines.push('');

        // Serie temporale (manteniamo i dati grezzi per compatibilità)
        lines.push('Sezione,Data,Ora,Visitatori (stima)');
        if(ts.labels.length===24){
          const day = (dailyRows && dailyRows[0] && dailyRows[0].date) || new Date().toISOString().slice(0,10);
          ts.labels.forEach((h,i)=>lines.push(`Serie temporale,${day},${h},${ts.values[i]}`));
        } else {
          ts.labels.forEach((d,i)=>lines.push(`Serie temporale,${d},,${ts.values[i]}`));
        }
        lines.push('');

        // Riepilogo giornaliero
        lines.push('Sezione,Data,Totale,Femminile,Maschile,Sconosciuto,Età mediana');
        dailyRows.forEach(r=>lines.push(`Riepilogo giornaliero,${r.date},${r.total},${r.f},${r.m},${r.u},${r.median}`));
        lines.push('');

        // Genere complessivo
        const gTot = gender.f + gender.m + gender.u;
        lines.push('Sezione,Etichetta,Valore,Percentuale');
        lines.push(`Genere complessivo,Femminile,${gender.f},${percent(gender.f,gTot)}`);
        lines.push(`Genere complessivo,Maschile,${gender.m},${percent(gender.m,gTot)}`);
        lines.push(`Genere complessivo,Sconosciuto,${gender.u},${percent(gender.u,gTot)}`);
        lines.push('');

        // Distribuzione età
        const ageTot = age.counts.reduce((a,b)=>a+b,0);
        lines.push('Sezione,Fascia età,Conteggio,Percentuale');
        for(let i=0;i<age.buckets.length;i++){
          lines.push(`Distribuzione età,${age.buckets[i]},${age.counts[i]},${percent(age.counts[i],ageTot)}`);
        }
        lines.push('');

        // Top ore per traffico
        const top = topHoursFrom(ts);
        lines.push('Sezione,Giorno,Ora,Passaggi');
        top.forEach(r=>lines.push(`Top ore per traffico,${r.day},${r.hour},${r.val}`));

        const blob = new Blob([lines.join('\n')], {type:'text/csv'});
        const a = document.createElement('a');
        const tsName = `${genAt.getFullYear()}${('0'+(genAt.getMonth()+1)).slice(-2)}${('0'+genAt.getDate()).slice(-2)}_${('0'+genAt.getHours()).slice(-2)}${('0'+genAt.getMinutes()).slice(-2)}${('0'+genAt.getSeconds()).slice(-2)}`;
        a.href = URL.createObjectURL(blob);
        a.download = `report_mydisplay_vision_${tsName}.csv`;
        a.click();
      }

      // ====== PDF Export ======
      function exportPDF(ts, dailyRows){
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('Libreria jsPDF non disponibile'); return; }
        const doc = new jsPDF('p','mm','a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 12;
        let y = margin;
        const now = new Date();

        // Title
        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('MyDisplay Vision – Report', margin, y); y+=8;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(`Generato il: ${now.toLocaleString('it-IT')}`, margin, y); y+=6;

        // Helper to add chart
        const addChart = (chart, title)=>{
          if(!chart) return; doc.setFont('helvetica','bold'); doc.setFontSize(12);
          doc.text(title, margin, y); y+=5;
          const img = chart.toBase64Image('image/png', 1);
          const cw = chart.canvas.width || 800; const ch = chart.canvas.height || 400;
          const imgW = pageWidth - margin*2; const imgH = (ch/cw) * imgW;
          doc.addImage(img, 'PNG', margin, y, imgW, imgH, undefined, 'FAST'); y += imgH + 6;
        };

        addChart(chartTime, 'Distribuzione traffico (radiale)');
        addChart(chartGenderDaily, 'Serie per genere (giorni)');

        // Daily table
        if(Array.isArray(dailyRows) && dailyRows.length){
          const head = [['Data','Totale','F','M','U','Età mediana']];
          const body = dailyRows.map(r=>[r.date, r.total, r.f, r.m, r.u, r.median]);
          if(typeof doc.autoTable === 'function'){
            doc.autoTable({ startY: y, head, body, styles:{ fontSize:9 } });
          } else {
            doc.setFont('helvetica','bold'); doc.text('Riepilogo giornaliero', margin, y); y+=5;
            body.forEach(row=>{ doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(row.join(' | '), margin, y); y+=5; });
          }
        }

        const tsName = `${now.getFullYear()}${('0'+(now.getMonth()+1)).slice(-2)}${('0'+now.getDate()).slice(-2)}_${('0'+(now.getHours())).slice(-2)}${('0'+now.getMinutes()).slice(-2)}${('0'+now.getSeconds()).slice(-2)}`;
        doc.save(`report_mydisplay_vision_${tsName}.pdf`);
      }

      // ====== Orchestrator ======
      function refresh(){
        const range = document.getElementById('range').value;
        const ts = generateTimeline(range);
        const daily = summarizeDaily(range, ts);
        const total = ts.values.reduce((a,b)=>a+b,0);
        const gender = deriveGenderTotals(total);
        const age = deriveAgeBuckets(total);
        renderCharts(ts, daily);
        fillTableDaily(daily);
        fillTableTop(topHoursFrom(ts));
        updateKpis(ts, gender, age);
        window.__lastData = {ts, daily, age, gender};
      }

      // Events
      window.addEventListener('DOMContentLoaded', ()=>{
        refresh();
        document.getElementById('regen').addEventListener('click', refresh);
        document.getElementById('range').addEventListener('change', refresh);
        document.getElementById('csv').addEventListener('click', ()=>{
          const d = window.__lastData; if(!d) return; exportCSV(d.ts, d.daily, d.age, d.gender);
        });
        document.getElementById('pdf').addEventListener('click', ()=>{
          const d = window.__lastData; if(!d) return; exportPDF(d.ts, d.daily);
        });
      });
    </script>
  </body>
</html>
