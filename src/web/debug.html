<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>MyDisplay Vision - Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; --bg:#0f1115; --card:#131722; --border:#1f2330; --muted:#94a3b8; --ok:#22c55e; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; background:var(--bg); color:#e5e7eb; font:13.5px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; overflow: hidden; }

    /* HEADER */
    .topbar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px; background:linear-gradient(180deg,#0f1115,rgba(15,17,21,.85));
      border-bottom:1px solid #131826; backdrop-filter: blur(6px);
    }
    .title{ font-size:18px; font-weight:700; margin:0; }
    .actions{ display:flex; gap:8px; align-items:center; }
    button{ background:#0d1320; color:#e5e7eb; border:1px solid #2a3142; border-radius:8px; padding:6px 10px; cursor:pointer; }
    button:hover{ background:#0f1728; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; }

    /* KPI */
    .kpis { display:flex; gap:10px; flex-wrap:wrap; padding: 0 14px 10px; }
    .kpi { background:#0d1320; border:1px solid #202637; border-radius:8px; padding:6px 10px; display:flex; gap:8px; align-items:center; }
    .dot { width:8px; height:8px; border-radius:999px; display:inline-block; }
    .on{ background:var(--ok); box-shadow:0 0 0 2px rgba(34,197,94,.25); } .off{ background:#334155; }

    /* LAYOUT */
    .wrap { padding: 0 14px 14px; display:flex; flex-direction:column; gap:12px; }
    /* Stream full-width, poi una griglia che si adatta */
    #cardStream{
      margin: 0;
      background:var(--card); border:1px solid var(--border);
      border-radius:10px; padding:10px;
      display:flex; flex-direction:column; min-height:0; position:relative; z-index:2; /* sopra eventuali sticky vicini */
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap:12px;
      grid-auto-flow: dense;           /* riempi buchi */
      align-items: stretch;
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:10px;
      padding:10px; display:flex; flex-direction:column; min-height:0; position:relative; overflow:hidden;
    }
    .card h2{ margin:0 0 8px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }

    /* STATUS BAR (Health & Stats compatto) */
    .statusbar{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      background:#0d1320; border:1px solid #202637; border-radius:8px;
      padding:8px 10px;
    }
    .field{
      display:flex; align-items:center; gap:6px;
      background:#0b0f1e; border:1px solid #1f2636; border-radius:999px;
      padding:4px 10px; font-size:12.5px;
    }
    .field b{ font-weight:600; color:#cbd5e1; }
    .field .val{ font-variant-numeric: tabular-nums; color:#e5e7eb; }
    .field .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
    .field .dot.ok{ background:var(--ok); box-shadow:0 0 0 2px rgba(34,197,94,.25); }
    .field .dot.ko{ background:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.25); }
    /* STREAM */
    .stream-wrap{ display:flex; flex-direction:column; gap:6px; min-height:0; height:100%; }
    .stream-controls{ flex:0 0 auto; }
    .stream-box{
      flex:1 1 auto;
      min-height:0;
      display:flex; align-items:center; justify-content:center;
      overflow:auto; background:#0b0e14; position:relative;
      border-radius:8px; border:1px solid #2a3142;
    }
    /* wrapper con rapporto 16:9 */
    .stream-aspect{ width:100%; position:relative; }
    .stream-aspect::before{ content:""; display:block; padding-top:56.25%; } /* 16:9 = 9/16 = 56.25% */
    #stream{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:contain; border-radius:8px;
    }

    /* --- STACK VERTICALE (SOLO PORTRAIT) --------------------------------- */
    @media (orientation: portrait){
      /* #main diventa un flex container verticale; niente griglia a righe fisse */
      #main{ display:flex; flex-direction:column; height: calc(100vh - var(--topbar-h)); }
      /* ‚Äúappiattisco‚Äù i wrapper cos√¨ le card diventano figli diretti e ordinabili */
      #gridWrap, #grid{ display:contents; }

      /* ordine richiesto: KPI -> Health -> Stream -> ReID -> Aggregati */
      #kpiBar{ order:1; }
      #cardHealth{ order:2; }
      #cardStream{ order:3; }
      #cardReid{ order:4; }
      #cardMetrics{ order:5; }

      /* card a tutta larghezza con spaziatura coerente */
      #cardHealth, #cardStream, #cardReid, #cardMetrics{ margin: 0 14px 12px; }

      /* riga stream si adatta al suo contenuto 16:9, niente spazi vuoti */
      .stream-box{ height:auto !important; flex:0 0 auto; }
      /* ---- Limiti di altezza SOLO in verticale ----
         ReID non pu√≤ occupare tutto: il corpo scorre entro il limite.
         Gli Aggregati hanno un limite pi√π basso.
      */
      #cardReid .scroll{
        max-height: 38vh;   /* ~2/5 dello schermo */
      }
      #cardMetrics .scroll{
        max-height: 26vh;   /* sufficiente per 8‚Äì10 righe */
      }
      #cardHealth .statusbar{ margin-bottom: 4px; } /* compattiamo un filo */
    }

    /* Chips */
    .chips{ display:flex; gap:6px; flex-wrap:nowrap; overflow:auto; }
    .chip{ display:inline-flex; gap:6px; align-items:center; padding:2px 8px; border:1px solid #2a3142; border-radius:999px; background:#0d1320; }

    /* Tabelle */
    table { width:100%; border-collapse:collapse; border:1px solid #273043; border-radius:8px; overflow:hidden; table-layout:fixed; }
    th, td { padding:8px 10px; border-bottom:1px solid #202637; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    th { background:#0f1526; color:#d8e1f7; text-align:left; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even) { background: #0d1320; }
    tbody tr:hover { background:#121a2d; }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .idrow.active{ background: rgba(34,197,94,.08); }
    .scroll{ overflow:auto; position:relative; } /* crea il contenitore di clipping per gli sticky */

    /* ICONCINE */
    .ico { display:inline-block; width:16px; height:16px; border-radius:4px; border:1px solid #3a445a; background:#0f172a; text-align:center; line-height:16px; font-size:11px; }
    .ico.on  { background:#0f2a17; border-color:#1e3a2f; }
    .ico.off { opacity:.5; }
    .badge { display:inline-block; padding:1px 6px; border:1px solid #39445a; border-radius:999px; background:#0f172a; }

    /* FULLSCREEN */
    .fs-host { position:fixed; inset:0; background:#000; z-index:9998; }
    .fs-img  { position:absolute; inset:0; margin:auto; width:96%; height:96%; object-fit:contain; border:none; }
    .fs-overlay { position:absolute; left:0; right:0; bottom:0; padding:10px 12px; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 40%, rgba(0,0,0,.55) 100%); display:flex; align-items:flex-end; justify-content:flex-start; pointer-events:none; }
    .fs-chips { pointer-events:auto; display:flex; gap:8px; flex-wrap:nowrap; overflow:auto; width:100%; }

    /* TOOLTIP */
    #_tip { position: fixed; z-index: 9999; display:none; max-width: 260px; padding:6px 8px; font-size:12px; line-height:1.2; background:#0b1220; color:#cbd5e1; border:1px solid #223050; border-radius:8px; box-shadow: 0 6px 22px rgba(0,0,0,.45); pointer-events: none; }

    /* MODAL CONFIG */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:9999; }
    .modal.show{ display:grid; }
    .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); }
    .dialog{ position:relative; width:min(960px, 96vw); height:min(70vh, 90vh); background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; box-shadow: 0 20px 60px rgba(0,0,0,.6); }
    .dialog .head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dialog .body{ flex:1; min-height:0; }
    .dialog .foot{ display:flex; justify-content:flex-end; gap:8px; }

    /* wrapper principale a altezza fissa calcolata da JS */
    :root{ --topbar-h: 0px; }

    /* Variabile usata solo in landscape */
    :root{ --stream-h: 44vh; }

    /* Default = portrait: stack flessibile */
    #main{ height: calc(100vh - var(--topbar-h)); display:flex; flex-direction:column; }
    /* Landscape: ripristino la griglia a 3 righe */
    @media (orientation: landscape){
      #main{
        display:grid;
        grid-template-rows: auto var(--stream-h) 1fr;
      }
    }

    /* va bene anche static; l‚Äôimportante √® misurarla e sottrarla */
    .topbar { position: static; }
    .kpis   { margin-top: -4px; }   /* fine tuning */

    /* area griglia che NON scorre: occupa lo spazio rimanente */
    #gridWrap { min-height: 0; overflow: hidden; }

    /* la griglia riempie lo spazio, ma non scrolla: scrollano le card */
    .grid {
      height: 100%;
      overflow: hidden;            /* niente scroll della griglia */
    }

    /* ogni card √® una colonna flex: header auto, contenuto scroll */
    .card { min-height: 0; display:flex; flex-direction:column; }
    .card .scroll { flex: 1 1 auto; min-height: 0; overflow: auto; }

    /* le due tabelle in Health&Stats devono poter scorrere ciascuna */
    #cardHealth .scroll { max-height: 100%; }

    /* opzionale: limite max alle card per evitare che righino oltre */
    .card { max-height: 100%; }

    /* Landscape: comportamento invariato */
    @media (orientation: landscape){ .stream-box{ height: 44vh; } }

    /* Breakpoint di sicurezza: sotto 800px, colonna singola comunque */
    @media (max-width: 800px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1 class="title">MyDisplay Vision ‚Äî Debug</h1>
    <div class="actions">
      <button id="btnFs">Schermo intero</button>
      <button id="btnOpenCfg">Impostazioni</button>
    </div>
  </div>

  <div id="main">
    <!-- KPI -->
    <div class="kpis" id="kpiBar">
      <div class="kpi"><span class="dot off" id="camDot"></span><span id="camTxt">Cam</span></div>
      <div class="kpi">FPS <strong id="kpiFps">‚Äî</strong></div>
      <div class="kpi">Size <strong id="kpiSize">‚Äî</strong></div>
      <div class="kpi">Uptime <strong id="kpiUptime">‚Äî</strong></div>
      <div class="kpi">ReID mem <strong id="kpiMem">0</strong></div>
      <div class="kpi">Active <strong id="kpiActive">0</strong></div>
    </div>

    <!-- STREAM FULL-WIDTH -->
    <div class="card" id="cardStream">
      <h2>Stream <span id="capInfo" class="muted"></span></h2>
      <div class="stream-wrap">
        <div class="stream-controls small">
          <label class="muted">scale</label>
          <select id="scaleSel">
            <option value="0.25">25%</option><option value="0.4">40%</option>
            <option value="0.5">50%</option><option value="0.75">75%</option>
            <option value="1" selected>100%</option>
          </select>
          <span class="muted">doppio-click o tasto <b>F</b></span>
        </div>
        <div class="stream-box" id="streamBox">
          <!-- wrapper con aspect-ratio 16:9 -->
          <div class="stream-aspect">
            <img id="stream" src="/debug/stream" alt="debug stream" />
          </div>
        </div>
        <div class="chips small" id="activeChips"><span class="muted">active: ‚Äî</span></div>
      </div>
    </div>

    <!-- WRAP della griglia a altezza fissa -->
    <div id="gridWrap">
      <div class="grid" id="grid">
        <!-- ReID: vuole tanto spazio -->
        <section class="card" id="cardReid" data-min="900">
          <h2>ReID Memory <span class="muted small" id="reidTs"></span></h2>
          <div class="scroll" style="flex:1; min-height:0;">
            <table>
              <thead>
                <tr>
                  <th class="th-tip" data-tip="Stato attivo nel frame corrente">on</th>
                  <th class="th-tip" data-tip="Identificatore globale (persistente)">#ID</th>
                  <th class="th-tip" data-tip="Embedding corpo (Body ReID) presente">body</th>
                  <th class="th-tip" data-tip="Volto presente in memoria (embedding)">face</th>
                  <th class="th-tip" data-tip="Genere prevalente visto su questo ID">gender</th>
                  <th class="th-tip" data-tip="Et√† prevalente vista su questo ID">age</th>
                  <th class="th-tip" data-tip="Numero aggiornamenti" style="text-align:right;">hits</th>
                  <th class="th-tip" data-tip="Secondi dalla creazione" style="text-align:right;">age (s)</th>
                  <th class="th-tip" data-tip="Secondi dall‚Äôultimo avvistamento" style="text-align:right;">last (s)</th>
                </tr>
              </thead>
              <tbody id="reidBody">
                <tr><td colspan="9" class="muted">‚Äî</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Aggregati: medio -->
        <section class="card" id="cardMetrics" data-min="620">
          <h2>Aggregati al minuto <span class="muted small" id="mTs"></span></h2>
          <div class="small" style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
            <label class="muted">last</label>
            <select id="mLast"><option>5</option><option selected>10</option><option>20</option><option>50</option></select>
            <span class="muted">include current</span><input type="checkbox" id="mCur" checked />
          </div>
          <div class="scroll" style="flex:1; min-height:0;">
            <table>
              <thead>
                <tr>
                  <th class="th-tip" data-tip="Timestamp finestra (UTC)">ts</th>
                  <th class="th-tip" data-tip="Totale persone"  style="text-align:right;">tot</th>
                  <th class="th-tip" data-tip="Maschi"  style="text-align:right;">Male</th>
                  <th class="th-tip" data-tip="Femmine"  style="text-align:right;">Female</th>
                  <th class="th-tip" data-tip="Sesso non classificato"  style="text-align:right;">Unknown</th>
                  <th class="th-tip" data-tip="Bucket et√† (0-13,14-24,...,65+)">ageBuckets</th>
                </tr>
              </thead>
              <tbody id="mBody">
                <tr><td colspan="6" class="muted">‚Äî</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Health&Stats: compatto -->
        <section class="card" id="cardHealth" data-min="420">
          <h2>Health & Stats</h2>
          <div class="statusbar">
            <button id="btnHs" class="small">refresh</button>
            <span class="muted small" id="hsTs"></span>
            <span class="field"><span id="hsCamDot" class="dot"></span><b>camera</b><span id="hsCam" class="val">‚Äî</span></span>
            <span class="field"><b>size</b><span id="hsSize" class="val">‚Äî</span></span>
            <span class="field"><b>since</b><span id="hsSince" class="val">‚Äî</span></span>
            <span class="field"><b>lastUpdate</b><span id="hsLast" class="val">‚Äî</span></span>
            <span class="field"><b>fps</b><span id="hsFps" class="val">‚Äî</span></span>
          </div>
        </section>
      </div>
    </div>
  </div>


  <!-- MODAL CONFIG -->
  <div class="modal" id="cfgModal" aria-hidden="true">
    <div class="backdrop" id="cfgBackdrop"></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
      <div class="head">
        <h2 id="cfgTitle" style="margin:0;">Impostazioni (config rilevante)</h2>
        <div class="actions">
          <button id="btnCfgReload">Ricarica</button>
          <button id="btnCloseCfg">Chiudi</button>
        </div>
      </div>
      <div class="body scroll">
        <table>
          <thead><tr><th>chiave</th><th>valore</th></tr></thead>
          <tbody id="tbCfg"></tbody>
        </table>
      </div>
      <div class="foot muted small">
        Valori in sola lettura qui. La modifica a runtime arriver√† in una finestra dedicata.
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="_tip"></div>

  <!-- Fullscreen host (iniettato) -->
  <template id="fsTpl">
    <div class="fs-host" id="fsHost">
      <img id="fsImg" class="fs-img" alt="stream" />
      <div class="fs-overlay">
        <div class="fs-chips small" id="activeChipsFs"></div>
      </div>
    </div>
  </template>

  <script>
    const $ = (id) => document.getElementById(id);
    const j = (v) => JSON.stringify(v);
    const ts = () => new Date().toLocaleTimeString();
    const fmtUptime = (sec) => { if (sec == null) return '‚Äî'; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${h}h ${m}m ${s}s`; };
    const kvRows = (obj) => Object.entries(obj || {}).map(([k,v]) => `<tr><td class="muted">${k}</td><td>${(typeof v==='object')? j(v) : v}</td></tr>`).join('');

    // STREAM scale
    const stream = $('stream'), streamBox = $('streamBox'), scaleSel = $('scaleSel'), capInfo = $('capInfo');
    scaleSel.onchange = () => { stream.style.transform = `scale(${parseFloat(scaleSel.value)})`; stream.style.transformOrigin='top left'; };
    scaleSel.onchange();

    // ---------- Fullscreen ----------
    let fsOn = false, prevScale = '1';
    const btnFs = $('btnFs');
    const fsTpl = $('fsTpl');
    let fsHost, fsImg;
    function enterFs(){
      if (fsOn) return;
      prevScale = scaleSel.value;
      const node = fsTpl.content.cloneNode(true);
      document.body.appendChild(node);
      fsHost = $('fsHost'); fsImg = $('fsImg');
      fsImg.src = stream.src;
      if (fsHost.requestFullscreen) fsHost.requestFullscreen();
      fsOn = true;
      stream.style.transform = '';
      renderActiveChips(lastActive, 'activeChipsFs');
      document.addEventListener('fullscreenchange', onFsChange);
    }
    function exitFs(){
      if (!fsOn) return;
      if (document.fullscreenElement) document.exitFullscreen();
      scaleSel.value = prevScale; scaleSel.onchange();
      if (fsHost && fsHost.parentNode) fsHost.parentNode.removeChild(fsHost);
      fsHost = null; fsImg = null; fsOn = false;
    }
    function onFsChange(){ if (!document.fullscreenElement) exitFs(); }
    btnFs.onclick = () => fsOn ? exitFs() : enterFs();
    streamBox.ondblclick = enterFs;
    document.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='f') enterFs(); });

    // ---------- Tooltip ----------
    (function tooltips(){
      const tip = $('_tip');
      function show(text, x, y){
        tip.textContent = text;
        tip.style.display = 'block';
        const pad = 10, w = tip.offsetWidth, h = tip.offsetHeight;
        let left = x + pad, top = y + pad;
        if (left + w > window.innerWidth) left = x - w - pad;
        if (top + h > window.innerHeight) top = y - h - pad;
        tip.style.left = left + 'px'; tip.style.top = top + 'px';
      }
      function hide(){ tip.style.display = 'none'; }
      document.addEventListener('mousemove', (e)=>{
        const el = e.target.closest('.th-tip');
        if (el && el.dataset.tip) { show(el.dataset.tip, e.clientX, e.clientY); }
        else hide();
      });
      document.addEventListener('scroll', hide, true);
      window.addEventListener('resize', hide);
    })();

    // ---------- Health & Stats ----------
    async function refreshHealthStats() {
      try {
        const [h, s] = await Promise.all([fetch('/health').then(r=>r.json()), fetch('/stats').then(r=>r.json())]);
        $('camDot').className = 'dot ' + (h.ok ? 'on' : 'off');
        $('camTxt').textContent = h.camera;
        $('kpiFps').textContent = (h.fps ?? '‚Äî');
        $('kpiSize').textContent = Array.isArray(h.size) ? `${h.size[0]}√ó${h.size[1]}` : '‚Äî';
        $('kpiUptime').textContent = fmtUptime(s.uptimeSec);
        if (Array.isArray(h.size)) capInfo.textContent = `¬∑ ${h.size[0]}√ó${h.size[1]} @‚âà${h.fps ?? '‚Äî'}fps`;
        // statusbar compatta
        $('hsCamDot').className = 'dot ' + (h.ok ? 'ok' : 'ko');
        $('hsCam').textContent  = h.camera ?? '‚Äî';
        $('hsSize').textContent = Array.isArray(h.size) ? `${h.size[0]}√ó${h.size[1]}` : '‚Äî';
        $('hsSince').textContent = h.since ?? '‚Äî';
        $('hsLast').textContent  = s.lastUpdate ?? '‚Äî';
        $('hsFps').textContent   = (s.lastFps ?? h.fps ?? '‚Äî');
        $('hsTs').textContent    = 'aggiornato: ' + ts();
      } catch (e) {
        $('hsCamDot').className = 'dot ko';
        $('hsCam').textContent  = '‚Äî'; $('hsSize').textContent='‚Äî'; $('hsSince').textContent='‚Äî'; $('hsLast').textContent='‚Äî'; $('hsFps').textContent='‚Äî';
        $('hsTs').textContent   = 'errore';
      }
    }

    // ---------- ReID ----------
    let lastActive = {};
    function renderActiveChips(active, targetId='activeChips'){
      lastActive = active;
      const ids = Object.keys(active).map(k=>parseInt(k,10)).sort((a,b)=>a-b);
      const html = ids.length ? ids.map(id => `<span class="chip"><span class="dot on"></span>#${id}</span>`).join('') : '<span class="muted">active: ‚Äî</span>';
      $(targetId).innerHTML = html;
      if (targetId==='activeChips' && $('activeChipsFs')) $('activeChipsFs').innerHTML = html;
    }
    async function refreshReID() {
      try {
        const data = await fetch('/debug/data').then(r => r.json());
        const mem = Array.isArray(data.mem) ? data.mem : [];
        const active = data.active || {};
        const now = Date.now()/1000;
        $('kpiMem').textContent = mem.length;
        $('kpiActive').textContent = Object.keys(active).length;
        renderActiveChips(active, 'activeChips');

        const tb = $('reidBody');
        if (!mem.length) { tb.innerHTML = '<tr><td colspan="9" class="muted">‚Äî</td></tr>'; }
        else {
          tb.innerHTML = mem.map(row => {
            const id = row.id ?? row.rawId ?? row.gid ?? row.pid;
            const on = !!active[id];
            const lastAgo = row.last ? Math.max(0, (now - row.last)).toFixed(1) : '';
            const age = row.ageSec != null ? Number(row.ageSec).toFixed(1) : '';
            const hits = row.hits ?? '';

            const hasSil = !!row.hasSilhouette;
            const hasFace = !!row.hasFace;
            const silCount = row.silCount ?? 0;
            const faceCount = row.faceCount ?? 0;

            const gender = (row.genderMajor || 'unknown');
            const ageBucket = (row.ageMajor || 'unknown');

            const silHTML  = `<span class="ico ${hasSil?'on':'off'}" title="silhouette/app count: ${silCount}">üßç</span>`;
            const faceHTML = `<span class="ico ${hasFace?'on':'off'}" title="face/emb count: ${faceCount}">üôÇ</span>`;
            const gBadge = `<span class="badge" title="gender hist: ${JSON.stringify(row.genderHist||{})}">${gender}</span>`;
            const aBadge = `<span class="badge" title="age hist: ${JSON.stringify(row.ageHist||{})}">${ageBucket}</span>`;

            return `<tr class="idrow ${on?'active':''}">
              <td><span class="dot ${on?'on':'off'}"></span></td>
              <td>#${id}</td>
              <td>${silHTML}</td>
              <td>${faceHTML}</td>
              <td>${gBadge}</td>
              <td>${aBadge}</td>
              <td class="num">${hits}</td>
              <td class="num">${age}</td>
              <td class="num">${lastAgo}</td>
            </tr>`;
          }).join('');
        }
        $('reidTs').textContent = 'aggiornato: ' + ts();
      } catch (e) { /* silent */ }
    }

    // ---------- Metrics ----------
    function renderMetrics(arr) {
      const tb = $('mBody');
      if (!Array.isArray(arr) || !arr.length) { tb.innerHTML = '<tr><td colspan="6" class="muted">‚Äî</td></tr>'; return; }
      tb.innerHTML = arr.map(r => {
        const c = r.counts || {}; const ages = r.ageBuckets || {};
        const ab = ['0-13','14-24','25-34','35-44','45-54','55-64','65+'].map(k => ages[k] ? `${k}:${ages[k]}` : '').filter(Boolean).join(' ');
        return `<tr>
          <td class="small">${(r.ts||'').replace('T',' ').replace('Z','')}</td>
          <td class="num">${c.total ?? ''}</td>
          <td class="num">${c.male ?? ''}</td>
          <td class="num">${c.female ?? ''}</td>
          <td class="num">${c.unknown ?? ''}</td>
          <td class="small">${ab || (ages.unknown ? 'unknown:'+ages.unknown : '')}</td>
        </tr>`;
      }).join('');
      $('mTs').textContent = 'aggiornato: ' + ts();
    }
    async function refreshMetrics() {
      const last = parseInt($('mLast').value,10) || 10;
      const includeCurrent = $('mCur').checked ? 1 : 0;
      try { const arr = await fetch(`/metrics/minute?last=${last}&includeCurrent=${includeCurrent}`).then(r=>r.json()); renderMetrics(arr); }
      catch { $('mBody').innerHTML = '<tr><td colspan="6" class="muted">errore /metrics/minute</td></tr>'; }
    }

    // ---------- Config (modal) ----------
    const CFG_KEYS = [
      'tracker_max_age','tracker_min_hits','tracker_iou_th',
      'reid_enabled','reid_model_path','reid_similarity_th',
      'reid_bank_size','reid_require_face_if_available',
      'body_reid_model_path','body_reid_input_w','body_reid_input_h',
      'body_reid_backend','body_reid_target','body_only_th',
      'reid_allow_body_seed','count_mode','presence_ttl_sec',
      'reid_memory_ttl_sec','count_dedup_ttl_sec','detector_resize_width',
      'person_model_path','person_img_size','person_score_th',
      'person_iou_th','person_max_det','metrics_window_sec',
      'cls_min_conf','cls_interval_ms','rtsp_transport',
      'rtsp_max_failures','debug_reid_verbose'
    ];
    async function loadConfigIntoModal(){
      try{
        const cfg = await fetch('/config').then(r=>r.json());
        $('tbCfg').innerHTML = CFG_KEYS.map(k => `<tr><td class="muted">${k}</td><td>${cfg[k] ?? ''}</td></tr>`).join('') || '<tr><td colspan="2" class="muted">‚Äî</td></tr>';
      }catch{
        $('tbCfg').innerHTML = '<tr><td colspan="2" class="muted">errore /config</td></tr>';
      }
    }
    const cfgModal = $('cfgModal'), btnOpenCfg = $('btnOpenCfg'), btnCloseCfg = $('btnCloseCfg'), cfgBackdrop = $('cfgBackdrop');
    function openCfg(){ cfgModal.classList.add('show'); cfgModal.setAttribute('aria-hidden','false'); loadConfigIntoModal(); }
    function closeCfg(){ cfgModal.classList.remove('show'); cfgModal.setAttribute('aria-hidden','true'); }
    btnOpenCfg.onclick = openCfg; btnCloseCfg.onclick = closeCfg; cfgBackdrop.onclick = closeCfg; $('btnCfgReload').onclick = loadConfigIntoModal;
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && cfgModal.classList.contains('show')) closeCfg(); });

    // --- blocco altezza: niente scroll pagina, solo interni ---
    function resizeMain(){
      const top = document.querySelector('.topbar');
      const h = top ? top.offsetHeight : 0;
      document.documentElement.style.setProperty('--topbar-h', h + 'px');
    }
    window.addEventListener('resize', resizeMain);
    window.addEventListener('orientationchange', resizeMain);
    document.addEventListener('DOMContentLoaded', resizeMain);
    // ---------- AUTO-SPAN GRID (card ‚Äúchiede‚Äù spazio) ----------
    const grid = $('grid');
    function computeColMetrics(){
      const cs = getComputedStyle(grid);
      const colDef = cs.gridTemplateColumns;                  // e.g. "384px 384px 384px"
      const cols = colDef.split(' ').length;
      const gap = parseFloat(cs.gap) || 0;
      // stima della larghezza colonna (prima entry)
      const first = colDef.split(' ')[0];
      const colW = parseFloat(first);                         // px
      return { cols, colW, gap };
    }
    function autospan(){
      const { cols, colW, gap } = computeColMetrics();
      const items = grid.querySelectorAll('.card');
      items.forEach(el=>{
        const want = parseInt(el.dataset.min || '360', 10);
        // quante colonne servono per raggiungere 'want'
        const span = Math.min(cols, Math.max(1, Math.round( (want + gap) / (colW + gap) )));
        el.style.gridColumn = `span ${span}`;
      });
    }
    // osserva resize del container
    const ro = new ResizeObserver(autospan);
    ro.observe(grid);
    window.addEventListener('resize', autospan);

    // ---------- Init + polling ----------
    function init(){
      autospan();
      refreshHealthStats(); refreshReID(); refreshMetrics();
      setInterval(refreshHealthStats, 2000);
      setInterval(refreshReID, 2000);
      setInterval(refreshMetrics, 5000);
    }
    // dopo primo layout
    requestAnimationFrame(init);
  </script>
</body>
</html>
