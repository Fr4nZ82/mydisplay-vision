<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyDisplay Vision – Report</title>
    <style>
      :root{
        color-scheme:dark;
        --bg:#0f1115; --card:#131722; --muted:#94a3b8; --text:#e5e7eb; --border:#202634; --accent:#7dd3fc;
        --f:#f472b6; --m:#60a5fa; --u:#94a3b8;
      }
      *{ box-sizing:border-box }
      html, body{ height:100% }
      body{
        margin:0; background:var(--bg); color:var(--text);
        font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;
      }
      .wrap{ max-width:1400px; margin:0 auto; padding:18px }
      header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px }
      .title{ font-size:18px; font-weight:700; letter-spacing:.2px }
      .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
      .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
      .kpis{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; margin-bottom:14px }
      .kpi{ display:flex; flex-direction:column; gap:6px }
      .kpi .lbl{ color:var(--muted); font-size:12px }
      .kpi .val{ font-size:20px; font-weight:700 }
      .grid{ display:grid; grid-template-columns:1.5fr 1fr; gap:12px }
      .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px }
      .sub{ color:var(--muted); font-size:12px }
      .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
      button,select{ background:#0b0e16; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
      button:hover{ border-color:#2c3549 }
      table{ width:100%; border-collapse:collapse }
      th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:left }
      th{ color:var(--muted); font-weight:600; font-size:12px }
      tbody tr:hover{ background:#0e1420 }
      .foot{ margin-top:18px; color:var(--muted); font-size:12px }

      /* Chart areas */
      .chart-box{ position:relative; height:320px; }
      canvas{ display:block; width:100% !important; height:100% !important; }

      /* Legend inline for radial chart */
      .legend{ display:flex; gap:10px; align-items:center; margin-top:6px; font-size:12px; color:var(--muted) }
      .legend .dot{ width:10px; height:10px; border-radius:999px; display:inline-block }

      @media (max-width: 1100px){ .grid{ grid-template-columns:1fr } }
      @media (max-width: 900px){ .kpis{ grid-template-columns:repeat(2,1fr) } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <div class="title">MyDisplay Vision – Report metriche</div>
          <div class="sub">Conteggio persone · sesso · età · finestra temporale</div>
        </div>
        <div class="controls">
          <div class="toolbar">
            <label for="range">Intervallo</label>
            <select id="range">
              <option value="today">Oggi</option>
              <option value="yesterday">Ieri</option>
              <option value="31d" selected>Ultimi 31 giorni</option>
              <option value="30d">Ultimi 30 giorni (giorni esatti)</option>
            </select>
            <button id="regen">Aggiorna dati</button>
            <button id="csv">Esporta CSV</button>
            <button id="pdf">Esporta PDF</button>
          </div>
        </div>
      </header>

      <section class="card kpis" id="kpiBox">
        <div class="kpi">
          <div class="lbl">Visitatori (stimati)</div>
          <div class="val" id="kpiVisitors">–</div>
          <div class="sub" id="kpiVisitorsSub">Somma persone uniche stimate</div>
        </div>
        <div class="kpi">
          <div class="lbl">Pico orario</div>
          <div class="val" id="kpiPeak">–</div>
          <div class="sub" id="kpiPeakSub">Ora con passaggi massimi</div>
        </div>
        <div class="kpi">
          <div class="lbl">Genere</div>
          <div class="val" id="kpiGender">–</div>
          <div class="sub" id="kpiGenderSub">F / M / U</div>
        </div>
        <div class="kpi">
          <div class="lbl">Età mediana</div>
          <div class="val" id="kpiAge">–</div>
          <div class="sub" id="kpiAgeSub">Distribuzione a fasce</div>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <div class="sub" style="margin-bottom:8px">Distribuzione oraria per genere (radiale 24h)</div>
          <div class="chart-box">
            <canvas id="chartTime"></canvas>
          </div>
          <div class="legend">
            <span class="dot" style="background:var(--f)"></span>Femminile
            <span class="dot" style="background:var(--m)"></span>Maschile
            <span class="dot" style="background:var(--u)"></span>Sconosciuto
          </div>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="sub">Serie per giorno (stack)</div>
            <div class="toolbar">
              <button id="toggleGA" title="Scambia tra stack Gender e Age">Gender / Age</button>
            </div>
          </div>
          <div class="chart-box">
            <canvas id="chartGenderDaily"></canvas>
          </div>
        </div>
      </section>

      <section class="grid2">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div class="sub">Riepilogo per giorno/ora</div>
          </div>
          <table id="tblDaily">
            <thead>
              <tr>
                <th>Data</th><th>Totale</th><th>F</th><th>M</th><th>U</th><th>Età mediana</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <div class="sub" style="margin-bottom:6px">Top ore per traffico</div>
          <table id="tblTop">
            <thead>
              <tr>
                <th>Giorno</th><th>Ora</th><th>Passaggi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <div class="foot">⚠️ Demo ⚠️</div>
    </div>

    <script>
      // ====== Utility ======
      const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
      const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
      function formatDate(d){return d.toISOString().slice(0,10)}
      function pad2(n){return (n<10?'0':'')+n}

      // ====== Fake data generator ======
      function generateTimeline(range){
        const now = new Date();
        let start, stepMs, points;
        if(range==='today'){
          start = new Date(now); start.setHours(0,0,0,0); stepMs = 60*60*1000; points=24; // hourly
        } else if(range==='yesterday'){
          start = new Date(now); start.setDate(now.getDate()-1); start.setHours(0,0,0,0); stepMs=60*60*1000; points=24;
        } else if(range==='30d'){
          start = new Date(now); start.setDate(now.getDate()-29); start.setHours(0,0,0,0); stepMs=24*60*60*1000; points=30;
        } else { // 31d (default)
          start = new Date(now); start.setDate(now.getDate()-30); start.setHours(0,0,0,0); stepMs=24*60*60*1000; points=31;
        }
        const labels=[], values=[];
        let base = (stepMs<24*60*60*1000)?rnd(4,18):rnd(50,180);
        for(let i=0;i<points;i++){
          const t = new Date(start.getTime()+i*stepMs);
          labels.push(stepMs<24*60*60*1000 ? `${pad2(t.getHours())}:00` : formatDate(t));
          let bump = 0;
          if(stepMs<24*60*60*1000){ // hourly
            const h=t.getHours();
            if(h>=7&&h<=9) bump+=rnd(8,18);
            if(h>=12&&h<=13) bump+=rnd(6,14);
            if(h>=17&&h<=19) bump+=rnd(9,22);
          } else {
            const dow = t.getDay();
            if(dow===6||dow===0) bump+=rnd(15,40);
          }
          base = clamp(base + rnd(-5,6), 2, 300);
          values.push(clamp(Math.round(base + bump + rnd(-3,3)), 0, 9999));
        }
        return {labels, values};
      }

      function deriveGenderTotals(total){
        let f = Math.round(total * (0.35 + Math.random()*0.25));
        let m = Math.round(total * (0.35 + Math.random()*0.25));
        let u = clamp(total - f - m, 0, total);
        return {f,m,u};
      }

      function deriveAgeBuckets(total){
        const buckets = ["0-12","13-17","18-24","25-34","35-44","45-54","55-64","65+"];
        const weights = [0.04,0.06,0.12,0.22,0.20,0.17,0.11,0.08].map(w=>w*(0.9+Math.random()*0.2));
        const sumW = weights.reduce((a,b)=>a+b,0);
        const counts = weights.map(w=>Math.round(total * w / sumW));
        const diff = total - counts.reduce((a,b)=>a+b,0);
        counts[counts.length-1]+=diff;
        return {buckets, counts};
      }

      function summarizeDaily(range, ts){
        const rows=[];
        const agesByDay=[];
        if(ts.labels.length===24){
          const today = new Date();
          const date = range==='yesterday'? new Date(today.getFullYear(),today.getMonth(),today.getDate()-1) : today;
          const total = ts.values.reduce((a,b)=>a+b,0);
          const g = deriveGenderTotals(total);
          const age = deriveAgeBuckets(total);
          rows.push({date:formatDate(date), total, ...g, median: estimateMedianAge(age), ageBuckets: age.counts});
          agesByDay.push(age.counts);
        } else {
          for(let i=0;i<ts.labels.length;i++){
            const total = ts.values[i];
            const g = deriveGenderTotals(total);
            const age = deriveAgeBuckets(total);
            rows.push({date:ts.labels[i], total, ...g, median: estimateMedianAge(age), ageBuckets: age.counts});
            agesByDay.push(age.counts);
          }
        }
        return rows;
      }

      function estimateMedianAge(age){
        const mids = [6,15,21,29,39,49,59,72];
        const {counts} = age;
        const total = counts.reduce((a,b)=>a+b,0);
        let acc=0;
        for(let i=0;i<counts.length;i++){
          acc += counts[i];
          if(acc>=total/2) return mids[i];
        }
        return 0;
      }

      function topHoursFrom(ts){
        const entries=[];
        if(ts.labels.length===24){
          ts.labels.forEach((h,i)=>entries.push({day:"oggi", hour:h, val:ts.values[i]}));
        } else {
          for(let d=0; d<ts.labels.length; d++){
            const base = Math.max(4, Math.round(ts.values[d]/24));
            const peaks = [rnd(8,10), rnd(12,14), rnd(17,19)];
            for(const p of peaks){ entries.push({day:ts.labels[d], hour: pad2(p)+":00", val: clamp(base + rnd(12,40), 0, 999)}); }
          }
        }
        entries.sort((a,b)=>b.val-a.val);
        return entries.slice(0,8);
      }

      // Costruisce un profilo orario (24h) aggregato al range selezionato
      function buildHourlyGenderDistribution(range, ts){
        const hours = Array.from({length:24}, (_,h)=>h);
        // Se ts è oraria la usiamo; se è giornaliera simuliamo un giorno medio scalato sul valore medio
        let baseDay = [];
        if(ts.labels.length===24){
          baseDay = ts.values.slice();
        } else {
          // pattern generico
          for(const h of hours){
            let v = 6 + Math.sin((h-8)/24 * Math.PI*2)*10 + (h>=17&&h<=19?12:0) + (h>=12&&h<=13?8:0);
            v = Math.max(2, Math.round(v + rnd(-2,3)));
            baseDay.push(v);
          }
          // scala rispetto alla media dei giorni
          const avgDaily = ts.values.reduce((a,b)=>a+b,0) / ts.values.length;
          const sumBase = baseDay.reduce((a,b)=>a+b,0);
          const scale = Math.max(1, Math.round(avgDaily / Math.max(1,sumBase)));
          baseDay = baseDay.map(v=>v*scale);
        }
        // split per genere per ora
        const F=[], M=[], U=[];
        for(const v of baseDay){
          const g = deriveGenderTotals(v);
          F.push(g.f); M.push(g.m); U.push(g.u);
        }
        return {F,M,U, totalByHour: baseDay};
      }

      // ====== Charts ======
      let chartGenderDaily; // Chart.js per il secondo grafico
      let isAgeMode = false; // toggle stato
      let currentDailyRows = [];
      let currentTs = null;

      // Radial stacked: disegna a mano su canvas
      function drawRadialStacked(canvas, hoursData){
        const ctx = canvas.getContext('2d');
        const DPR = window.devicePixelRatio || 1;
        const {width, height} = canvas.getBoundingClientRect();
        canvas.width = width * DPR; canvas.height = height * DPR;
        ctx.scale(DPR, DPR);

        ctx.clearRect(0,0,width,height);

        const cx = width/2, cy = height/2;
        const margin = 28;
        const innerR = 30;
        const outerR = Math.min(cx,cy) - margin;
        const maxVal = Math.max(...hoursData.totalByHour, 1);
        const ringTicks = [0.25, 0.5, 0.75];

        // griglia circolare + etichette
        ctx.strokeStyle = '#1e2636';
        ctx.fillStyle = '#76839a';
        ctx.lineWidth = 1;
        ctx.font = '11px system-ui';
        ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
        ringTicks.forEach(p=>{
          const r = innerR + (outerR-innerR)*p;
          ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
          ctx.fillText(Math.round(maxVal*p).toString(), cx + r + 6, cy);
        });

        // spicchi: 24 ore
        const hours = 24;
        const gap = Math.PI/180 * 2.5; // piccolo gap angolare
        const fullAngle = Math.PI*2;
        const step = fullAngle / hours;

        const colors = {F:getComputedStyle(document.documentElement).getPropertyValue('--f').trim(),
                        M:getComputedStyle(document.documentElement).getPropertyValue('--m').trim(),
                        U:getComputedStyle(document.documentElement).getPropertyValue('--u').trim()};

        for(let h=0; h<hours; h++){
          const a0 = -Math.PI/2 + h*step + gap/2;
          const a1 = -Math.PI/2 + (h+1)*step - gap/2;

          const tot = hoursData.totalByHour[h] || 0;
          const rTot = innerR + (outerR-innerR) * (tot / maxVal);

          // stack radiale: F poi M poi U
          const segs = [
            {v: hoursData.F[h], col: colors.F, lbl:'F'},
            {v: hoursData.M[h], col: colors.M, lbl:'M'},
            {v: hoursData.U[h], col: colors.U, lbl:'U'}
          ];
          let rStart = innerR;
          for(const s of segs){
            const rEnd = rStart + (outerR-innerR) * (s.v / Math.max(maxVal,1));
            ctx.beginPath();
            ctx.moveTo(cx + rStart*Math.cos(a0), cy + rStart*Math.sin(a0));
            ctx.arc(cx,cy,rEnd,a0,a1);
            ctx.lineTo(cx + rStart*Math.cos(a1), cy + rStart*Math.sin(a1));
            ctx.arc(cx,cy,rStart,a1,a0,true);
            ctx.closePath();
            ctx.fillStyle = s.col; ctx.globalAlpha = 0.9; ctx.fill(); ctx.globalAlpha = 1;
            rStart = rEnd;
          }

          // etichetta ora all'esterno
          ctx.save();
          ctx.fillStyle = '#b9c2d0';
          ctx.font = '10px system-ui';
          const mid = (a0+a1)/2;
          const tx = cx + (outerR+10)*Math.cos(mid);
          const ty = cy + (outerR+10)*Math.sin(mid);
          ctx.textAlign = Math.cos(mid)>0 ? 'left' : 'right';
          ctx.textBaseline = 'middle';
          ctx.fillText(pad2(h)+':00', tx, ty);
          ctx.restore();
        }
      }

      // costruzione dataset Chart.js per daily (gender vs age)
      function buildGenderDatasets(rows, nCols){
        const labels = rows.map(r=>r.date);
        const dataF = rows.map(r=>r.f);
        const dataM = rows.map(r=>r.m);
        const dataU = rows.map(r=>r.u);

        const categoryPct = Math.max(0.95, Math.min(1.0, 36 / nCols));
        const barPct = Math.max(0.98, Math.min(1.0, 32 / nCols));
        const maxBarThickness = Math.max(18, Math.min(50, Math.round(600 / nCols)));
        // stile comune per tutte le barre
        const commonBarStyle = {
          borderColor: '#000000',
          borderWidth: 2,
          categoryPercentage: categoryPct,
          barPercentage: barPct,
          maxBarThickness
        };

        return {
          labels,
          datasets: [
            {label:'Femminile', data:dataF, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--f').trim(), stack:'S', ...commonBarStyle},
            {label:'Maschile', data:dataM, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--m').trim(), stack:'S', ...commonBarStyle},
            {label:'Sconosciuto', data:dataU, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--u').trim(), stack:'S', ...commonBarStyle}
          ]
        };
      }

      function buildAgeDatasets(rows, nCols){
        const labels = rows.map(r=>r.date);
        // somma/usa le 8 fasce di età per giorno
        const bucketLabels = ["0-12","13-17","18-24","25-34","35-44","45-54","55-64","65+"];
        const colors = ['#fde68a','#fca5a5','#93c5fd','#86efac','#c7d2fe','#f9a8d4','#a5b4fc','#e5e7eb'];
        const datasets = bucketLabels.map((b,i)=>({
          label:b,
          data: rows.map(r=> (r.ageBuckets && r.ageBuckets[i]) || 0 ),
          backgroundColor: colors[i],
          stack:'AGE'
        }));

        const categoryPct = Math.max(0.95, Math.min(1.0, 36 / nCols));
        const barPct = Math.max(0.98, Math.min(1.0, 32 / nCols));
        const maxBarThickness = Math.max(18, Math.min(50, Math.round(600 / nCols)));
        // stile comune per tutte le barre
        const commonBarStyle = {
          borderColor: '#000000',
          borderWidth: 2,
          categoryPercentage: categoryPct,
          barPercentage: barPct,
          maxBarThickness
        };
        datasets.forEach(ds => Object.assign(ds, commonBarStyle));

        return { labels, datasets };
      }

      function renderDailyChart(rows){
        const n = rows.length || 1;
        const ctxGD = document.getElementById('chartGenderDaily');
        if(chartGenderDaily) chartGenderDaily.destroy();
        const base = buildGenderDatasets(rows, n);
        chartGenderDaily = new Chart(ctxGD, {
          type:'bar',
          data: base,
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'top', labels:{ usePointStyle:true } } },
            scales:{
              x:{ stacked:true, grid:{color:'#1e2636'} },
              y:{ stacked:true, beginAtZero:true, grid:{color:'#1e2636'} }
            }
          }
        });
        isAgeMode = false;
      }

      function toggleGenderAge(){
        if(!chartGenderDaily) return;
        const rows = currentDailyRows;
        const n = rows.length || 1;
        if(isAgeMode){
          const g = buildGenderDatasets(rows, n);
          chartGenderDaily.data.labels = g.labels;
          chartGenderDaily.data.datasets = g.datasets;
          isAgeMode = false;
        } else {
          const a = buildAgeDatasets(rows, n);
          chartGenderDaily.data.labels = a.labels;
          chartGenderDaily.data.datasets = a.datasets;
          isAgeMode = true;
        }
        chartGenderDaily.update();
      }

      // ====== Tables ======
      function fillTableDaily(rows){
        const tb = document.querySelector('#tblDaily tbody');
        tb.innerHTML = rows.map(r=>`<tr><td>${r.date}</td><td>${r.total}</td><td>${r.f}</td><td>${r.m}</td><td>${r.u}</td><td>${r.median}</td></tr>`).join('');
      }
      function fillTableTop(rows){
        const tb = document.querySelector('#tblTop tbody');
        tb.innerHTML = rows.map(r=>`<tr><td>${r.day}</td><td>${r.hour}</td><td>${r.val}</td></tr>`).join('');
      }

      // ====== KPIs ======
      function updateKpis(ts, g, age){
        const total = ts.values.reduce((a,b)=>a+b,0);
        const peak = Math.max(...ts.values);
        const peakIdx = ts.values.indexOf(peak);
        const peakLabel = ts.labels[peakIdx];
        const median = estimateMedianAge(age);
        document.getElementById('kpiVisitors').textContent = total.toLocaleString('it-IT');
        document.getElementById('kpiPeak').textContent = peak.toLocaleString('it-IT');
        document.getElementById('kpiPeakSub').textContent = `Picco: ${peakLabel}`;
        document.getElementById('kpiGender').textContent = `${g.f}/${g.m}/${g.u}`;
        document.getElementById('kpiAge').textContent = `${median}`;
      }

      // ====== CSV Export (invariato, usa la serie grezza) ======
      function exportCSV(ts, dailyRows, age, gender){
        const lines = [];
        const rangeVal = (document.getElementById('range')||{}).value || '31d';
        const rangeLbl = ({today:'Oggi',yesterday:'Ieri','31d':'Ultimi 31 giorni','30d':'Ultimi 30 giorni'})[rangeVal] || rangeVal;
        const gran = ts.labels.length===24 ? 'Oraria' : 'Giornaliera';
        const genAt = new Date();
        const totalVisitors = ts.values.reduce((a,b)=>a+b,0);
        const percent = (part,total)=> total>0 ? ((part/total)*100).toFixed(1)+'%' : '0%';

        lines.push('Sezione,Campo,Valore');
        lines.push(`Meta,Generato il,${genAt.toLocaleString('it-IT')}`);
        lines.push(`Meta,Intervallo selezionato,${rangeLbl}`);
        lines.push(`Meta,Granularità serie temporale,${gran}`);
        lines.push(`Meta,Visitatori totali (stima),${totalVisitors}`);
        lines.push('');

        lines.push('Sezione,Data,Ora,Visitatori (stima)');
        if(ts.labels.length===24){
          const day = (dailyRows && dailyRows[0] && dailyRows[0].date) || new Date().toISOString().slice(0,10);
          ts.labels.forEach((h,i)=>lines.push(`Serie temporale,${day},${h},${ts.values[i]}`));
        } else {
          ts.labels.forEach((d,i)=>lines.push(`Serie temporale,${d},,${ts.values[i]}`));
        }
        lines.push('');

        lines.push('Sezione,Data,Totale,Femminile,Maschile,Sconosciuto,Età mediana');
        dailyRows.forEach(r=>lines.push(`Riepilogo giornaliero,${r.date},${r.total},${r.f},${r.m},${r.u},${r.median}`));
        lines.push('');

        const gTot = gender.f + gender.m + gender.u;
        lines.push('Sezione,Etichetta,Valore,Percentuale');
        lines.push(`Genere complessivo,Femminile,${gender.f},${percent(gender.f,gTot)}`);
        lines.push(`Genere complessivo,Maschile,${gender.m},${percent(gender.m,gTot)}`);
        lines.push(`Genere complessivo,Sconosciuto,${gender.u},${percent(gender.u,gTot)}`);
        lines.push('');

        const ageTot = age.counts.reduce((a,b)=>a+b,0);
        lines.push('Sezione,Fascia età,Conteggio,Percentuale');
        for(let i=0;i<age.buckets.length;i++){
          lines.push(`Distribuzione età,${age.buckets[i]},${age.counts[i]},${percent(age.counts[i],ageTot)}`);
        }
        lines.push('');

        const top = topHoursFrom(ts);
        lines.push('Sezione,Giorno,Ora,Passaggi');
        top.forEach(r=>lines.push(`Top ore per traffico,${r.day},${r.hour},${r.val}`));

        const blob = new Blob([lines.join('\n')], {type:'text/csv'});
        const a = document.createElement('a');
        const tsName = `${genAt.getFullYear()}${('0'+(genAt.getMonth()+1)).slice(-2)}${('0'+genAt.getDate()).slice(-2)}_${('0'+genAt.getHours()).slice(-2)}${('0'+genAt.getMinutes()).slice(-2)}${('0'+genAt.getSeconds()).slice(-2)}`;
        a.href = URL.createObjectURL(blob);
        a.download = `report_mydisplay_vision_${tsName}.csv`;
        a.click();
      }

      // ====== PDF Export ======
      function exportPDF(ts, dailyRows){
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('Libreria jsPDF non disponibile'); return; }
        const doc = new jsPDF('p','mm','a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 12;
        let y = margin;
        const now = new Date();

        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('MyDisplay Vision – Report', margin, y); y+=8;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(`Generato il: ${now.toLocaleString('it-IT')}`, margin, y); y+=6;

        // Snapshot canvas del grafico radiale
        const canv = document.getElementById('chartTime');
        const img = canv.toDataURL('image/png', 1);
        const imgW = pageWidth - margin*2; const imgH = imgW * 0.5;
        doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text('Distribuzione oraria per genere (radiale)', margin, y); y+=5;
        doc.addImage(img, 'PNG', margin, y, imgW, imgH, undefined, 'FAST'); y += imgH + 6;

        // Secondo grafico
        if(chartGenderDaily){
          const img2 = chartGenderDaily.toBase64Image('image/png',1);
          const cw = chartGenderDaily.canvas.width || 800; const ch = chartGenderDaily.canvas.height || 400;
          const imgW2 = pageWidth - margin*2; const imgH2 = (ch/cw) * imgW2;
          doc.text('Serie per giorno (stack)', margin, y); y+=5;
          doc.addImage(img2, 'PNG', margin, y, imgW2, imgH2, undefined, 'FAST'); y += imgH2 + 6;
        }

        if(Array.isArray(dailyRows) && dailyRows.length){
          const head = [['Data','Totale','F','M','U','Età mediana']];
          const body = dailyRows.map(r=>[r.date, r.total, r.f, r.m, r.u, r.median]);
          if(typeof doc.autoTable === 'function'){
            doc.autoTable({ startY: y, head, body, styles:{ fontSize:9 } });
          }
        }

        const tsName = `${now.getFullYear()}${('0'+(now.getMonth()+1)).slice(-2)}${('0'+now.getDate()).slice(-2)}_${('0'+(now.getHours())).slice(-2)}${('0'+now.getMinutes()).slice(-2)}${('0'+now.getSeconds()).slice(-2)}`;
        doc.save(`report_mydisplay_vision_${tsName}.pdf`);
      }

      // ====== Orchestrator ======
      function refresh(){
        const range = document.getElementById('range').value;
        const ts = generateTimeline(range);
        const daily = summarizeDaily(range, ts);
        const total = ts.values.reduce((a,b)=>a+b,0);
        const gender = deriveGenderTotals(total);
        const age = deriveAgeBuckets(total);

        // Grafico radiale custom
        currentTs = ts;
        const hourly = buildHourlyGenderDistribution(range, ts);
        drawRadialStacked(document.getElementById('chartTime'), hourly);

        // Grafico giornaliero Chart.js
        currentDailyRows = daily;
        renderDailyChart(daily);

        fillTableDaily(daily);
        fillTableTop(topHoursFrom(ts));
        updateKpis(ts, gender, age);
        window.__lastData = {ts, daily, age, gender};
      }

      window.addEventListener('DOMContentLoaded', ()=>{
        refresh();
        document.getElementById('regen').addEventListener('click', refresh);
        document.getElementById('range').addEventListener('change', refresh);
        document.getElementById('toggleGA').addEventListener('click', toggleGenderAge);
        document.getElementById('csv').addEventListener('click', ()=>{
          const d = window.__lastData; if(!d) return; exportCSV(d.ts, d.daily, d.age, d.gender);
        });
        document.getElementById('pdf').addEventListener('click', ()=>{
          const d = window.__lastData; if(!d) return; exportPDF(d.ts, d.daily);
        });
      });
    </script>
  </body>
</html>
